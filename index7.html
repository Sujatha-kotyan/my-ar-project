<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AR Bubble Shooter</title>

<script type="module"
  src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js">
</script>

<style>
  body {
    margin: 0;
    overflow: hidden;
    background: black;
  }

  model-viewer {
    position: fixed;
    inset: 0;
    z-index: 0;
  }

  /* ðŸ”µ ALL BUBBLES */
  .bubble {
    position: absolute;
    z-index: 10;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: radial-gradient(circle, #9cf, #38f);
    cursor: pointer;
  }

  /* ðŸ”´ TARGET BUBBLES */
  .target {
    background: radial-gradient(circle, #f99, #c33);
  }

  /* ðŸ’¥ POP EFFECT */
  .pop {
    animation: pop 0.3s forwards;
  }

  @keyframes pop {
    to {
      transform: scale(2);
      opacity: 0;
    }
  }
</style>
</head>

<body>

<!-- AR MODEL (VISUAL ONLY) -->
<model-viewer
  id="viewer"
  src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
  camera-controls
  auto-rotate
  style="width:100vw;height:100vh;"
></model-viewer>

<!-- ðŸ”µ SHOOTER -->
<div id="shooter" class="bubble" style="left:50%; bottom:30px;"></div>

<!-- ðŸ”´ TARGETS -->
<div class="bubble target" data-score="10" style="left:40%; top:120px;"></div>
<div class="bubble target" data-score="-5" style="left:55%; top:160px;"></div>
<div class="bubble target" data-score="20" style="left:48%; top:220px;"></div>

<script>
let score = 0;
const shooter = document.getElementById("shooter");

shooter.addEventListener("click", shootBubble);

function shootBubble() {
  const bubble = shooter.cloneNode(true);
  document.body.appendChild(bubble);

  let x = shooter.offsetLeft;
  let y = shooter.offsetTop;

  bubble.style.left = x + "px";
  bubble.style.top = y + "px";
  bubble.style.bottom = "auto";

  function move() {
    y -= 6;
    bubble.style.top = y + "px";

    document.querySelectorAll(".target").forEach(target => {
      if (isColliding(bubble, target)) {

        const value = parseInt(target.dataset.score);
        score += value;

        target.classList.add("pop");
        bubble.remove();

        // ðŸ‘‰ SEND SCORE TO STORYLINE
        parent.postMessage(
          { type: "SCORE", value: score },
          "*"
        );

        console.log("ðŸŽ¯ HIT:", value, "TOTAL:", score);
        return;
      }
    });

    if (y < -40) {
      bubble.remove();
      return;
    }

    requestAnimationFrame(move);
  }

  move();
}

// ðŸ” COLLISION CHECK
function isColliding(a, b) {
  const r1 = a.getBoundingClientRect();
  const r2 = b.getBoundingClientRect();

  return !(
    r1.top > r2.bottom ||
    r1.bottom < r2.top ||
    r1.left > r2.right ||
    r1.right < r2.left
  );
}
</script>

</body>
</html>
